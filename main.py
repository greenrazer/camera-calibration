import cv2
import numpy as np

import image_utils
import utils
import li_utils
import draw_utils

import calibrate_camera
import two_view_calibration
import bundle_adjustment

def try1():
    train_card = image_utils.open_and_white_balance("photos/test_card.jpg")
    
    train =  image_utils.show_img_select_rois('Select Color', train_card, single=True)
    hsv_train = cv2.cvtColor(train, cv2.COLOR_BGR2HSV)
    lower, upper = image_utils.hsv_color_filter(hsv_train)

    target = image_utils.open_and_white_balance("photos/star.jpg", hsv=True)

    inv_mask = image_utils.color_filter_mask(target, lower, upper, inv=True)

    image_utils.show_image('howdi', inv_mask)
    #colors too close to one another.

    keypoints = image_utils.detect_circular_blobs(inv_mask)

    keypoint_img = cv2.drawKeypoints(target, keypoints, np.array([]), (255,255,0), cv2.DRAW_MATCHES_FLAGS_DRAW_RICH_KEYPOINTS)

    image_utils.show_image('howdi', cv2.cvtColor(keypoint_img, cv2.COLOR_HSV2BGR))

def try2():
    target = cv2.imread("photos/star.jpg")
    points = image_utils.show_image_select_points('Select points', target)

    target_hsv = cv2.cvtColor(target, cv2.COLOR_BGR2HSV)

    target_patch = image_utils.extract_square_patch(target, points[0], 150)
    target_patch_hsv = cv2.cvtColor(target_patch, cv2.COLOR_BGR2HSV)
    cv2.imshow('fuck', target_patch)
    
    print((points[0][0], points[0][1]))
    print(target_hsv.shape)
    point_color = target_hsv[points[0][0], points[0][1] , :]
    lower_c, upper_c = image_utils.color_hsv_epsilon(point_color, 20, 100, 255)
    mask = image_utils.color_filter_mask(target_patch_hsv, lower_c, upper_c)
    
    sw = utils.SliderWindow('square_patch')
    sw.add_image(mask)
    sw.add_slider('h_epsilon', 20)
    sw.add_slider('s_epsilon', 100)
    sw.add_slider('v_epsilon', 255)

    def on_change(obj):
        eh = obj.get_slider_value('h_epsilon')
        es = obj.get_slider_value('s_epsilon')
        ev = obj.get_slider_value('v_epsilon')

        lower_c, upper_c = image_utils.color_hsv_epsilon(point_color, eh, es, ev)
        mask = image_utils.color_filter_mask(target_patch_hsv, lower_c, upper_c)
        sw.display_img(mask)
    
    sw.add_callback(on_change)

    sw.show()

    if cv2.waitKey(0):
        cv2.destroyAllWindows()

def try3():
    vs = cv2.VideoCapture(0)

    obj_track = image_utils.ObjectTracker(draw_debug=True)

    while True:
        ret, frame = vs.read()
        
        boxes = obj_track.update(frame)

        key = cv2.waitKey(1) & 0xFF

        if key == ord("s"):
            obj_track.add_new_tracker(frame)
        if key == ord('q'):
            break        

        cv2.imshow('hi', frame)

    cv2.destroyAllWindows()

def try4():
    DIST = .33
    # mirrored x = -x y = y z = z
    real_points_m = np.array([
        [0,0,0], # White
        [DIST,0,0], # Purple
        [-DIST,0,0], # Silver
        [0,DIST,0], # Orange
        [0,-DIST,0], # Red
        [0,0,DIST], # Blue
        [0,0,-DIST], # Yellow
    ])

    # real_points_m = np.random.rand(*real_points_m.shape)
    # points = np.random.rand(real_points_m.shape[0], 2)

    colors = [
        [255,255,255], # White
        [250, 150, 150], # Purple
        [220, 220, 220], # Silver
        [0, 165, 255],  # Orange
        [0, 0, 255], # Red
        [255, 0, 0], # Blue
        [0, 255, 255], # Yellow
    ]

    imgs = [
        cv2.imread("photos/star.jpg"),
        cv2.imread("photos/star2.jpg"),
        cv2.imread("photos/star3.jpg"),
        cv2.imread("photos/star5.jpg"),
        cv2.imread("photos/star6.jpg"),
    ]

    points0 = [(0.4766666666666667, 0.4425), (0.8416666666666667, 0.7925), (0.20333333333333334, 0.2175), (0.62, 0.56125), (0.20333333333333334, 0.12375), (0.03, 0.69625), (0.9183333333333333, 0.17875)]
    points1 = [(0.51, 0.5), (0.86125, 0.58), (0.20625, 0.4125), (0.4925, 0.25125), (0.515, 0.645), (0.59125, 0.25), (0.40375, 0.83375)]
    points2 = [(0.49375, 0.59375), (0.4725, 0.69625), (0.53, 0.42125), (0.75, 0.54625), (0.2125, 0.65875), (0.4375, 0.37875), (0.58125, 0.87125)]
    points4 = [(0.53375, 0.56875), (0.54125, 0.6625), (0.5225, 0.455), (0.66125, 0.5275), (0.39875, 0.615), (0.48875, 0.485), (0.59125, 0.66625)]
    points5 = [(0.615, 0.33875), (0.68, 0.48625), (0.53375, 0.165), (0.72875, 0.2375), (0.4925, 0.45375), (0.5, 0.33625), (0.77375, 0.34125)]


    all_points = [points0, points1, points2, points4, points5]

    for num in range(len(imgs)):

        points = np.array(all_points[num])
        imag = imgs[num]

        def display(p):
            internal, rotation, position = li_utils.get_projection_product_matricies(p)

            internal, rotation = li_utils.fix_rotation_matrix(internal, rotation)
            plt = draw_utils.show_scene(real_points_m, internal, rotation, position)
        
        def draw_on_pic(P, show_projected_points=False):
            new_points = calibrate_camera.camera_project_points(P, real_points_m)

            drawn = image_utils.draw_points_on_image(imag, new_points, radius=20, colors=colors)
            if show_projected_points:
                image_utils.show_image("howdy", drawn)
            display(P)

        P = calibrate_camera.calibrate_camera(real_points_m, points)
        draw_on_pic(P, show_projected_points=True)

def try5():

    DIST = .33

    real_points_m = np.array([
        [0,0,0], # White
        [DIST,0,0], # Purple
        [-DIST,0,0], # Silver
        [0,DIST,0], # Orange
        [0,-DIST,0], # Red
        [0,0,DIST], # Blue
        [0,0,-DIST], # Yellow
    ])

    # real_points_m = np.random.rand(*real_points_m.shape)
    # points = np.random.rand(real_points_m.shape[0], 2)

    colors = [
        [255,255,255], # White
        [250, 150, 150], # Purple
        [220, 220, 220], # Silver
        [0, 165, 255],  # Orange
        [0, 0, 255], # Red
        [255, 0, 0], # Blue
        [0, 255, 255], # Yellow
    ]

    color_names = [
        "white",
        "purple",
        "silver",
        "orange",
        "red",
        "blue",
        "yellow"
    ]

    vs = cv2.VideoCapture('photos/star_v.mp4')

    ret, frame = vs.read()

    # obj_track = image_utils.ObjectTracker(draw_debug=True)
    # boxes_d = []
    # for i, point3d in enumerate(real_points_m):
    #     box = obj_track.add_new_tracker(frame, window_name=color_names[i])
    #     boxes_d.append(box)
    # print(boxes_d)

    boxes = [(693, 686, 45, 60), (708, 662, 45, 36), (667, 746, 43, 48), (688, 945, 45, 50), (720, 422, 45, 62), (441, 686, 36, 48), (960, 715, 45, 50)]

    obj_track = image_utils.ObjectTracker.from_boxes(frame, boxes, draw_debug=True, colors=colors)

    boxes = obj_track.update(frame)

    # np.set_printoptions(precision=2)
    # np.set_printoptions(suppress=True)
    np.set_printoptions(linewidth=180)

    centers = np.array([image_utils.center_of_box(box) for box in boxes])
    P, P_norm = calibrate_camera.calibrate_camera(real_points_m, centers)
    internal, rotation, position = li_utils.get_projection_product_matricies(P)
    plt = draw_utils.show_scene(real_points_m, internal, rotation, position, colors=np.array(colors)/255)
    line = position
    internal, _, _ = li_utils.get_projection_product_matricies(P_norm)

    while True:
        ret, frame = vs.read()
        if ret:
            boxes = obj_track.update(frame)

            scaled_im, scale = image_utils.resize_keep_aspect_ratio(frame, width=600)

            cv2.imshow('hi', scaled_im)

            centers = np.array([image_utils.center_of_box(box) for box in boxes])

            P, P_norm = calibrate_camera.calibrate_camera_const_internals(real_points_m, centers, internal, P_norm)
            _, rotation, position = li_utils.get_projection_product_matricies(P)

            line = np.hstack([line, position])

            key = cv2.waitKey(1) & 0xFF
            if key == ord('q'):
                break
        else:
            break

    _, rotation, position = li_utils.get_projection_product_matricies(P)

    ax = draw_utils.show_scene(real_points_m, internal, rotation, position, line=line)
    cv2.destroyAllWindows()

def try6():
    centers_each_frame=[[[715.5, 716.0], [730.5, 680.0], [688.5, 770.0], [710.5, 970.0], [742.5, 453.0], [459.0, 710.0], [982.5, 740.0]], [[720.5, 717.0], [736.5, 681.0], [692.5, 772.0], [715.0, 972.5], [747.5, 453.0], [463.0, 710.0], [989.0, 741.5]], [[729.5, 721.0], [744.5, 684.5], [699.5, 777.0], [723.5, 979.0], [756.5, 456.0], [470.5, 714.0], [998.5, 746.0]], [[743.5, 725.0], [760.0, 688.5], [710.5, 781.0], [739.0, 984.5], [773.5, 457.0], [482.0, 718.5], [1016.0, 750.5]], [[764.0, 731.5], [776.5, 691.5], [722.5, 787.0], [757.0, 991.5], [791.5, 461.0], [496.0, 718.5], [1037.0, 754.5]], [[780.0, 744.5], [798.0, 705.0], [743.5, 803.0], [772.0, 1006.5], [808.5, 477.0], [521.0, 740.5], [1059.5, 774.0]], [[802.5, 767.0], [821.0, 727.0], [761.5, 825.0], [797.0, 1034.0], [830.0, 498.0], [538.0, 757.5], [1083.5, 796.0]], [[812.0, 774.5], [837.0, 736.0], [772.0, 833.5], [806.0, 1042.0], [841.5, 504.0], [549.5, 765.0], [1097.0, 804.5]], [[811.5, 773.0], [836.0, 734.5], [766.5, 832.0], [804.5, 1042.5], [839.0, 499.0], [546.5, 763.0], [1094.5, 805.0]], [[793.0, 764.5], [819.5, 727.0], [745.5, 825.0], [784.0, 1035.0], [821.0, 490.0], [526.5, 754.0], [1076.5, 798.0]], [[772.5, 758.0], [801.0, 717.5], [724.0, 818.5], [762.0, 1029.0], [802.5, 482.0], [506.5, 745.5], [1057.0, 791.5]], [[754.0, 754.5], [784.5, 714.5], [704.0, 816.5], [743.0, 1026.0], [786.0, 478.5], [488.0, 742.0], [1040.0, 789.5]], [[744.5, 760.0], [778.0, 720.5], [690.5, 822.0], [733.0, 1032.0], [777.0, 483.5], [478.0, 746.0], [1030.5, 796.0]], [[735.5, 766.0], [770.5, 725.0], [679.5, 829.0], [723.5, 1039.0], [769.5, 488.0], [468.0, 750.0], [1022.5, 803.0]], [[728.5, 769.0], [765.5, 727.5], [669.0, 832.5], [716.5, 1044.0], [761.0, 489.5], [459.5, 753.5], [1015.5, 805.0]], [[725.0, 764.5], [765.0, 723.0], [665.5, 830.0], [714.5, 1040.0], [759.5, 483.5], [455.0, 749.5], [1014.5, 802.0]], [[727.5, 764.0], [768.5, 721.5], [664.0, 829.5], [716.5, 1040.0], [761.0, 481.0], [455.5, 750.0], [1019.0, 801.5]], [[730.0, 771.5], [772.5, 732.5], [663.5, 840.0], [719.0, 1052.0], [761.5, 489.5], [457.0, 760.5], [1021.5, 810.0]], [[736.0, 785.5], [778.0, 742.0], [667.0, 850.5], [727.0, 1065.0], [765.0, 500.0], [460.5, 774.0], [1030.0, 820.5]], [[725.5, 780.0], [770.5, 737.5], [654.0, 847.5], [717.5, 1062.5], [753.5, 491.5], [450.0, 769.5], [1023.5, 814.0]], [[713.5, 770.0], [761.5, 726.5], [640.0, 839.5], [707.5, 1054.5], [742.5, 479.5], [437.5, 761.0], [1016.5, 805.0]], [[702.0, 772.5], [752.0, 728.0], [625.5, 844.0], [697.5, 1058.5], [729.0, 480.0], [425.0, 764.5], [1008.0, 805.5]], [[690.0, 772.5], [743.5, 727.5], [613.0, 845.5], [688.0, 1060.0], [715.5, 476.0], [411.5, 764.0], [998.5, 805.0]], [[680.5, 765.0], [733.5, 719.5], [600.5, 838.0], [678.5, 1055.0], [705.5, 466.0], [399.0, 757.5], [990.0, 796.5]], [[672.0, 755.5], [727.5, 708.5], [589.0, 830.0], [671.5, 1047.5], [697.5, 453.0], [389.5, 749.0], [985.0, 786.5]], [[660.0, 755.5], [716.0, 709.0], [573.5, 831.5], [659.5, 1050.5], [684.0, 450.0], [373.0, 749.5], [974.0, 786.5]], [[637.5, 762.0], [696.0, 715.0], [549.0, 838.0], [638.0, 1059.0], [660.5, 454.0], [347.0, 753.5], [952.0, 793.5]], [[617.5, 770.0], [679.0, 723.0], [526.0, 846.0], [617.5, 1070.5], [641.5, 460.0], [325.5, 762.0], [934.0, 802.5]], [[604.5, 773.0], [669.0, 726.0], [510.0, 850.0], [603.0, 1077.0], [630.5, 461.0], [309.5, 765.0], [923.5, 807.5]], [[606.0, 778.5], [670.5, 728.5], [504.5, 856.5], [602.5, 1083.5], [630.5, 462.0], [307.5, 768.0], [927.5, 813.5]], [[606.0, 784.5], [674.0, 735.0], [502.5, 865.5], [602.0, 1093.0], [631.0, 466.5], [305.5, 775.0], [931.5, 821.5]], [[598.0, 785.5], [668.5, 734.5], [490.0, 868.0], [594.0, 1096.0], [624.0, 463.5], [296.0, 773.5], [926.5, 823.5]], [[588.5, 784.0], [661.0, 731.0], [477.5, 868.5], [585.0, 1097.0], [615.5, 458.5], [285.0, 770.5], [919.0, 823.0]], [[581.0, 784.5], [655.5, 731.5], [466.0, 873.5], [577.0, 1100.5], [607.5, 458.5], [273.5, 772.0], [914.0, 825.0]], [[575.0, 788.5], [653.5, 734.5], [457.5, 878.5], [572.5, 1107.0], [601.5, 459.5], [267.5, 775.0], [910.5, 829.5]], [[575.0, 791.5], [656.0, 736.0], [454.5, 882.5], [573.0, 1111.5], [601.0, 459.0], [266.0, 778.0], [914.5, 831.5]], [[576.0, 790.5], [659.5, 732.5], [452.5, 882.5], [575.5, 1112.0], [602.0, 454.5], [265.5, 775.5], [918.0, 830.0]], [[576.0, 784.5], [662.5, 727.5], [448.5, 880.5], [576.5, 1109.0], [601.0, 447.5], [264.5, 771.5], [919.0, 825.0]], [[576.0, 782.5], [664.5, 723.5], [443.5, 878.5], [576.5, 1109.0], [599.5, 443.5], [263.5, 769.5], [923.0, 823.0]], [[573.0, 782.5], [663.5, 723.5], [436.5, 879.5], [574.0, 1110.5], [595.5, 440.5], [258.5, 769.5], [920.0, 822.0]], [[568.0, 781.5], [661.0, 723.0], [428.5, 880.5], [569.5, 1112.0], [590.5, 439.5], [253.5, 770.0], [916.0, 823.0]], [[562.0, 780.5], [660.0, 721.0], [418.0, 880.0], [565.5, 1113.0], [584.0, 435.0], [247.5, 768.0], [914.0, 822.0]], [[558.0, 774.5], [657.5, 713.5], [408.5, 874.5], [560.0, 1108.5], [578.5, 425.5], [241.5, 761.0], [911.5, 815.5]], [[553.5, 767.0], [657.0, 706.0], [399.0, 868.0], [556.5, 1101.0], [575.0, 416.0], [236.0, 753.0], [908.5, 809.5]], [[550.5, 760.0], [656.5, 697.5], [392.5, 860.5], [553.5, 1097.0], [571.5, 406.0], [232.5, 744.5], [908.5, 803.5]], [[548.0, 753.5], [658.0, 691.5], [385.5, 854.5], [553.5, 1092.0], [569.5, 398.0], [230.5, 738.0], [907.5, 798.5]], [[548.0, 742.5], [661.5, 681.0], [380.5, 845.5], [552.5, 1082.0], [569.5, 385.0], [229.5, 727.0], [909.0, 789.5]], [[551.0, 727.5], [666.0, 666.5], [377.0, 831.5], [554.5, 1069.0], [571.5, 367.0], [232.5, 711.0], [912.5, 775.0]], [[555.0, 721.5], [675.0, 659.5], [377.5, 828.0], [559.5, 1063.0], [577.5, 358.5], [238.5, 703.5], [919.5, 772.0]], [[561.0, 717.5], [685.0, 654.5], [379.5, 823.0], [564.0, 1058.5], [584.5, 351.5], [246.5, 696.5], [926.5, 769.5]], [[568.0, 712.5], [695.0, 648.5], [381.0, 818.5], [571.5, 1055.0], [592.0, 345.5], [253.5, 690.5], [935.0, 764.5]], [[577.5, 709.0], [708.0, 644.5], [384.5, 816.0], [580.5, 1052.0], [602.0, 341.5], [265.0, 687.0], [945.0, 764.5]], [[587.0, 706.5], [722.0, 643.5], [390.5, 812.0], [590.0, 1051.5], [611.5, 336.5], [276.5, 683.5], [955.0, 764.5]], [[597.0, 705.5], [736.0, 641.5], [394.5, 813.0], [599.5, 1050.0], [621.5, 336.5], [289.0, 683.0], [966.0, 765.5]], [[608.0, 707.5], [752.0, 641.5], [403.5, 814.0], [611.5, 1051.0], [634.5, 335.5], [303.5, 682.5], [978.0, 767.5]], [[622.0, 710.5], [768.0, 643.5], [411.5, 818.0], [624.5, 1055.0], [647.5, 338.5], [320.0, 684.5], [993.0, 772.5]], [[637.0, 720.5], [786.0, 652.5], [422.5, 828.0], [640.5, 1064.0], [662.5, 348.5], [338.5, 693.0], [1008.0, 783.5]], [[653.0, 735.5], [805.5, 666.0], [437.0, 843.5], [657.0, 1079.5], [679.0, 362.5], [356.0, 706.5], [1024.5, 799.0]], [[671.0, 739.5], [826.0, 669.5], [450.5, 848.0], [673.5, 1084.0], [696.0, 366.5], [375.5, 710.0], [1042.5, 805.0]], [[686.5, 732.0], [845.0, 662.5], [464.0, 842.5], [691.5, 1079.0], [712.5, 359.0], [393.0, 704.5], [1058.5, 800.0]], [[701.5, 731.0], [862.5, 660.0], [475.5, 840.5], [705.5, 1078.0], [726.5, 355.0], [410.0, 700.5], [1075.0, 798.5]], [[713.5, 730.0], [878.0, 658.5], [484.5, 839.5], [719.5, 1077.0], [740.0, 353.0], [423.0, 698.5], [1089.0, 798.5]], [[724.5, 726.0], [891.5, 655.0], [492.0, 836.0], [729.5, 1076.0], [749.0, 348.0], [434.0, 695.5], [1100.0, 797.5]], [[730.5, 729.0], [901.5, 657.0], [495.5, 839.5], [735.5, 1080.0], [757.0, 349.0], [442.5, 698.0], [1109.0, 800.5]], [[736.5, 731.0], [910.5, 659.0], [498.5, 841.0], [742.5, 1083.0], [763.0, 350.0], [449.5, 699.0], [1116.0, 804.5]], [[740.5, 722.0], [916.5, 651.0], [497.5, 831.5], [744.5, 1075.0], [767.0, 339.0], [452.5, 689.0], [1120.0, 798.5]], [[740.5, 712.0], [918.5, 639.0], [496.0, 822.0], [745.5, 1065.0], [769.0, 325.0], [453.5, 676.0], [1122.0, 788.5]], [[740.5, 705.0], [921.0, 631.5], [492.5, 815.5], [744.5, 1060.0], [768.0, 316.0], [453.5, 669.0], [1123.0, 782.5]], [[740.0, 696.5], [922.0, 623.5], [489.5, 807.5], [743.5, 1053.0], [767.5, 305.0], [452.0, 660.5], [1123.0, 776.5]], [[738.0, 689.5], [923.5, 616.0], [482.5, 802.5], [740.5, 1048.0], [766.5, 296.0], [449.5, 652.0], [1123.0, 772.5]], [[737.5, 691.0], [923.5, 617.0], [478.5, 803.5], [739.5, 1051.0], [765.5, 296.0], [448.0, 653.5], [1122.0, 774.5]], [[733.5, 698.0], [923.5, 624.0], [470.0, 812.5], [734.5, 1059.0], [761.0, 302.0], [444.0, 658.5], [1120.0, 783.5]], [[730.5, 700.0], [923.5, 625.0], [465.0, 814.5], [733.5, 1063.0], [760.0, 301.0], [442.5, 659.0], [1118.5, 787.0]], [[727.5, 700.0], [924.5, 624.0], [458.0, 815.5], [730.5, 1065.0], [758.0, 297.0], [437.5, 658.0], [1118.0, 787.0]], [[724.5, 702.0], [920.5, 627.0], [450.0, 819.5], [725.5, 1069.0], [753.0, 297.0], [433.5, 659.0], [1114.0, 792.0]], [[718.5, 704.0], [920.5, 630.0], [440.0, 823.5], [721.0, 1073.5], [748.0, 298.0], [429.0, 660.5], [1112.0, 797.0]], [[715.5, 708.0], [918.5, 631.0], [432.0, 827.5], [718.0, 1078.5], [744.5, 298.0], [424.5, 664.0], [1109.0, 801.5]], [[713.5, 711.0], [919.5, 633.0], [424.5, 831.0], [714.0, 1083.5], [741.5, 298.0], [422.5, 665.0], [1108.0, 806.5]], [[711.5, 717.0], [921.0, 640.5], [416.5, 839.0], [713.0, 1093.5], [738.0, 304.0], [421.5, 672.0], [1107.0, 816.5]], [[705.0, 726.5], [918.0, 648.5], [405.0, 848.5], [707.0, 1103.5], [731.0, 311.0], [414.0, 679.5], [1101.0, 825.5]], [[698.0, 729.5], [916.0, 649.5], [395.0, 853.5], [702.0, 1107.5], [724.0, 311.0], [409.5, 682.0], [1095.5, 830.5]], [[698.0, 735.5], [920.5, 653.0], [390.5, 862.5], [703.5, 1116.0], [724.5, 316.0], [410.5, 687.0], [1096.5, 837.5]], [[694.5, 747.0], [921.5, 662.0], [383.5, 875.5], [700.5, 1128.0], [719.0, 324.0], [406.5, 696.0], [1095.0, 850.0]], [[690.5, 750.0], [921.5, 664.0], [373.5, 882.5], [698.5, 1134.0], [714.0, 327.0], [403.5, 700.0], [1092.0, 857.0]], [[689.5, 745.0], [923.5, 660.0], [368.5, 879.5], [696.5, 1132.0], [711.0, 320.0], [401.5, 695.0], [1091.0, 854.0]], [[687.0, 744.5], [927.0, 656.5], [362.5, 878.0], [696.5, 1131.0], [710.0, 315.0], [402.0, 691.5], [1090.0, 853.0]], [[687.0, 748.5], [927.5, 660.0], [358.0, 884.5], [694.5, 1137.0], [709.0, 318.0], [401.0, 695.5], [1090.0, 860.0]], [[686.0, 754.5], [929.5, 666.0], [353.0, 890.5], [694.5, 1144.0], [707.0, 323.0], [400.5, 700.0], [1089.0, 867.0]], [[683.5, 753.0], [933.5, 662.0], [348.0, 889.5], [693.5, 1143.0], [706.0, 319.0], [399.5, 696.0], [1089.0, 867.0]], [[683.5, 749.0], [935.0, 660.5], [344.0, 886.5], [694.0, 1139.5], [706.0, 312.0], [400.5, 692.0], [1088.0, 865.0]], [[685.5, 749.0], [936.0, 659.0], [341.0, 885.5], [695.0, 1139.5], [705.0, 310.0], [402.5, 691.0], [1088.0, 866.0]], [[686.5, 751.0], [942.0, 660.5], [339.0, 888.5], [697.0, 1143.5], [706.5, 311.0], [405.5, 692.0], [1090.0, 869.0]], [[688.5, 755.0], [946.0, 664.5], [337.0, 892.5], [699.0, 1147.5], [707.5, 313.0], [409.5, 696.0], [1091.0, 874.0]], [[691.5, 756.0], [949.0, 666.5], [334.5, 895.5], [701.0, 1153.5], [708.5, 315.0], [414.0, 697.5], [1092.0, 879.0]], [[695.5, 757.0], [956.0, 667.5], [334.5, 894.5], [705.0, 1153.5], [712.0, 314.0], [419.0, 697.5], [1096.0, 880.0]], [[699.5, 757.0], [963.5, 668.0], [335.5, 895.5], [709.0, 1155.5], [716.5, 314.0], [425.0, 697.5], [1100.0, 882.0]], [[702.5, 755.0], [971.5, 667.0], [335.5, 892.5], [714.0, 1154.5], [718.5, 309.0], [432.0, 695.5], [1102.0, 882.0]], [[707.5, 755.0], [978.5, 665.0], [337.5, 892.5], [719.0, 1153.5], [723.5, 307.0], [439.0, 692.5], [1106.0, 883.0]], [[710.5, 757.0], [988.5, 665.0], [339.5, 894.5], [724.0, 1156.0], [727.0, 308.0], [445.5, 694.0], [1108.0, 886.0]], [[715.5, 756.0], [995.0, 666.5], [340.5, 892.5], [728.0, 1155.0], [733.5, 307.0], [453.0, 691.5], [1112.0, 888.0]], [[720.5, 754.0], [1005.0, 661.5], [340.5, 889.5], [733.0, 1153.0], [738.0, 302.0], [460.0, 688.5], [1116.0, 889.0]], [[725.5, 753.0], [1014.0, 662.5], [344.5, 886.5], [737.0, 1152.0], [744.0, 301.0], [467.0, 685.5], [1121.0, 890.0]], [[731.0, 749.5], [1023.0, 657.5], [348.0, 882.0], [742.0, 1149.0], [751.0, 295.0], [474.0, 680.5], [1123.5, 891.0]], [[736.0, 745.5], [1032.0, 653.5], [353.0, 877.0], [747.0, 1145.0], [757.0, 290.0], [481.0, 674.5], [1127.5, 887.0]], [[742.0, 738.5], [1039.0, 647.5], [355.0, 871.0], [752.0, 1138.0], [762.0, 282.0], [489.0, 667.5], [1130.5, 883.0]], [[747.0, 730.5], [1049.0, 638.5], [359.0, 862.0], [758.0, 1129.0], [768.0, 273.0], [496.0, 658.5], [1135.5, 877.0]], [[754.0, 721.5], [1057.0, 632.0], [364.0, 856.0], [765.0, 1122.0], [774.0, 264.0], [504.0, 649.5], [1139.5, 870.0]], [[760.0, 713.5], [1066.0, 622.0], [367.0, 847.0], [770.0, 1114.0], [779.0, 255.0], [511.5, 642.0], [1144.5, 864.0]], [[765.0, 703.5], [1073.0, 611.0], [371.5, 836.5], [777.0, 1102.0], [782.0, 241.0], [518.5, 630.5], [1149.5, 853.0]], [[769.0, 694.5], [1080.0, 603.0], [372.5, 828.5], [782.0, 1095.0], [787.0, 231.0], [525.0, 622.0], [1153.5, 845.0]], [[773.0, 688.5], [1086.0, 595.0], [375.5, 822.5], [787.0, 1089.0], [789.0, 224.0], [530.0, 616.0], [1156.5, 840.0]], [[775.0, 681.5], [1091.5, 588.5], [375.5, 814.5], [789.0, 1082.0], [791.0, 215.0], [534.0, 608.0], [1158.5, 833.0]], [[779.0, 671.5], [1098.5, 578.5], [376.5, 805.5], [793.0, 1074.0], [793.5, 201.5], [538.0, 599.0], [1161.5, 824.0]], [[782.0, 669.5], [1104.0, 576.5], [376.5, 804.5], [798.0, 1073.0], [796.5, 199.5], [542.5, 597.5], [1164.5, 822.0]], [[786.0, 670.5], [1110.0, 576.5], [378.5, 805.5], [802.0, 1076.0], [798.5, 199.5], [546.5, 598.5], [1169.5, 823.5]], [[789.5, 669.0], [1116.0, 575.5], [379.5, 803.5], [806.0, 1076.0], [804.0, 195.0], [550.5, 596.5], [1175.5, 822.5]], [[794.0, 669.5], [1122.0, 574.5], [380.5, 803.5], [811.0, 1077.0], [805.5, 193.5], [555.5, 596.5], [1178.5, 824.5]], [[797.0, 672.5], [1128.0, 576.5], [382.5, 807.5], [815.0, 1083.0], [808.5, 193.5], [559.5, 599.5], [1183.5, 828.5]], [[800.0, 677.5], [1134.0, 581.5], [381.5, 813.5], [818.0, 1089.0], [810.5, 198.5], [561.5, 603.5], [1186.5, 834.5]], [[801.0, 681.5], [1138.0, 585.5], [380.5, 819.5], [820.0, 1096.0], [812.5, 199.5], [565.0, 608.0], [1191.5, 841.5]], [[801.5, 685.0], [1142.0, 586.5], [377.5, 822.5], [821.5, 1101.5], [812.5, 200.5], [564.5, 610.5], [1191.5, 845.5]], [[798.0, 689.5], [1141.0, 590.5], [370.5, 829.5], [819.5, 1107.5], [808.5, 201.5], [562.0, 614.0], [1190.0, 850.5]], [[794.0, 694.5], [1139.0, 595.5], [364.0, 836.0], [815.5, 1115.5], [802.5, 204.5], [558.5, 619.5], [1188.0, 858.5]], [[791.0, 699.5], [1139.0, 599.5], [356.0, 843.0], [813.5, 1122.5], [798.5, 206.5], [554.5, 623.5], [1186.0, 864.5]], [[784.5, 705.0], [1134.0, 603.5], [343.0, 850.0], [805.5, 1130.5], [791.5, 208.5], [547.5, 627.5], [1180.0, 872.5]], [[780.5, 705.0], [1134.0, 604.5], [335.0, 852.0], [802.5, 1134.5], [789.5, 205.5], [544.0, 627.5], [1179.0, 877.5]], [[780.5, 707.0], [1135.5, 604.5], [330.0, 855.0], [801.5, 1138.5], [788.0, 205.0], [542.0, 627.5], [1181.0, 882.5]], [[772.5, 715.0], [1130.5, 613.5], [318.0, 865.0], [793.5, 1149.5], [781.0, 210.0], [534.5, 633.5], [1175.0, 892.5]], [[773.5, 728.0], [1135.5, 626.5], [316.0, 878.0], [795.5, 1166.5], [783.0, 220.0], [535.5, 646.5], [1179.0, 907.5]], [[776.0, 736.5], [1139.0, 634.5], [313.5, 887.5], [796.5, 1179.5], [784.0, 227.0], [535.5, 653.5], [1183.5, 920.0]], [[767.0, 732.5], [1132.0, 632.5], [299.5, 884.5], [787.5, 1178.5], [776.0, 218.0], [526.0, 648.0], [1177.5, 920.0]], [[760.0, 728.5], [1127.0, 625.5], [287.5, 880.5], [781.5, 1174.5], [768.0, 208.0], [518.5, 641.5], [1172.5, 916.0]], [[757.5, 727.0], [1128.0, 623.5], [282.0, 883.0], [781.5, 1175.5], [765.0, 204.0], [517.5, 641.5], [1172.5, 916.0]], [[755.5, 731.0], [1127.0, 624.5], [276.0, 890.0], [779.5, 1182.5], [758.0, 205.5], [514.0, 645.5], [1172.0, 922.0]], [[751.5, 735.0], [1126.0, 626.5], [270.0, 895.0], [778.5, 1188.5], [753.0, 207.5], [512.5, 651.0], [1169.0, 924.0]], [[755.0, 734.5], [1131.0, 626.5], [270.5, 894.0], [783.5, 1191.5], [755.0, 205.0], [516.0, 653.5], [1173.0, 920.0]], [[754.5, 731.0], [1133.0, 626.5], [268.5, 889.0], [785.5, 1190.5], [753.0, 199.0], [515.5, 653.0], [1173.0, 915.0]], [[751.5, 729.0], [1133.0, 624.0], [262.5, 888.0], [783.5, 1190.5], [746.0, 194.0], [514.5, 653.0], [1171.0, 910.0]], [[750.5, 729.0], [1134.5, 623.5], [259.5, 888.0], [783.5, 1192.5], [744.0, 192.5], [513.5, 655.0], [1171.0, 907.0]], [[746.5, 729.0], [1131.5, 620.5], [253.5, 892.0], [783.5, 1193.5], [736.0, 190.5], [510.5, 655.0], [1168.0, 907.0]], [[741.5, 730.0], [1128.0, 620.0], [247.5, 897.0], [778.5, 1195.5], [729.0, 191.5], [505.0, 655.5], [1163.0, 909.0]], [[744.5, 735.0], [1133.0, 623.0], [247.5, 904.0], [782.5, 1201.5], [730.0, 195.5], [509.0, 659.5], [1164.0, 915.0]], [[748.5, 742.0], [1139.0, 629.5], [251.0, 910.5], [787.5, 1208.5], [734.0, 201.5], [513.5, 665.0], [1168.0, 924.0]], [[750.5, 745.0], [1143.0, 633.0], [252.0, 912.5], [790.5, 1214.5], [739.0, 204.5], [518.5, 667.0], [1172.0, 932.0]], [[759.5, 751.0], [1152.0, 640.5], [259.0, 919.5], [795.5, 1220.5], [748.0, 211.5], [526.5, 671.0], [1179.0, 942.0]], [[764.5, 756.0], [1161.0, 646.0], [261.0, 922.5], [799.5, 1226.5], [755.0, 214.5], [532.0, 673.5], [1185.0, 952.0]], [[763.5, 758.0], [1164.0, 647.0], [259.0, 926.5], [798.5, 1228.5], [756.0, 215.0], [531.5, 672.0], [1184.0, 960.0]], [[762.5, 763.0], [1165.0, 652.0], [256.0, 932.5], [796.5, 1233.5], [757.0, 219.5], [531.5, 673.0], [1184.0, 972.0]], [[761.5, 765.0], [1166.0, 653.0], [250.0, 936.5], [792.5, 1236.5], [756.0, 221.0], [529.5, 672.0], [1183.0, 981.0]], [[760.0, 766.5], [1166.0, 653.0], [246.0, 938.5], [790.5, 1236.5], [755.5, 220.0], [526.0, 669.5], [1182.0, 989.0]], [[757.5, 768.0], [1166.0, 652.5], [240.0, 940.5], [786.5, 1237.5], [754.5, 218.5], [524.5, 666.0], [1180.0, 996.0]], [[756.0, 767.5], [1166.0, 652.0], [237.0, 940.5], [783.0, 1237.0], [756.5, 217.5], [524.0, 662.5], [1179.0, 1003.0]], [[757.0, 767.5], [1170.0, 651.5], [235.0, 942.5], [782.0, 1237.0], [758.5, 216.5], [522.5, 659.0], [1180.0, 1011.0]], [[756.0, 771.5], [1170.0, 656.5], [232.5, 947.5], [780.0, 1243.0], [759.5, 220.5], [523.0, 662.5], [1179.0, 1021.0]], [[756.5, 780.0], [1173.0, 663.5], [229.5, 954.5], [780.0, 1251.0], [760.5, 227.0], [522.5, 665.0], [1179.0, 1034.0]], [[760.0, 777.5], [1181.0, 663.5], [230.5, 952.5], [784.0, 1251.0], [766.5, 224.0], [527.5, 663.0], [1185.0, 1037.0]], [[765.0, 777.5], [1190.5, 662.0], [237.0, 951.5], [790.0, 1250.0], [772.5, 222.0], [535.0, 660.5], [1190.0, 1040.0]], [[768.0, 782.5], [1194.5, 668.0], [235.5, 961.0], [792.0, 1258.0], [772.5, 230.0], [537.5, 666.0], [1190.0, 1049.0]], [[761.0, 786.5], [1191.5, 671.0], [228.5, 964.0], [788.0, 1261.0], [764.5, 230.0], [533.0, 667.5], [1183.0, 1054.0]], [[758.0, 780.5], [1190.5, 664.0], [222.5, 958.0], [785.0, 1255.0], [758.5, 221.0], [532.0, 661.5], [1176.0, 1047.0]], [[757.0, 781.5], [1190.5, 665.0], [219.5, 964.0], [785.0, 1258.0], [756.5, 224.0], [534.0, 665.5], [1174.0, 1050.0]], [[753.0, 791.5], [1189.5, 674.0], [215.0, 974.0], [783.0, 1268.0], [749.5, 236.0], [533.0, 674.5], [1167.0, 1060.0]], [[749.0, 796.5], [1185.5, 681.0], [209.0, 980.0], [780.0, 1275.0], [740.5, 243.0], [531.5, 681.0], [1158.0, 1065.0]], [[744.0, 798.5], [1182.5, 681.5], [202.0, 983.0], [777.0, 1278.0], [733.5, 244.0], [529.5, 683.0], [1149.0, 1068.0]], [[732.0, 798.5], [1174.5, 680.5], [190.0, 983.0], [768.0, 1278.0], [718.5, 244.0], [519.5, 683.0], [1133.0, 1067.0]], [[719.0, 798.5], [1162.0, 679.5], [175.0, 983.0], [757.0, 1277.0], [704.5, 242.0], [510.0, 682.5], [1116.0, 1066.0]], [[713.0, 798.5], [1157.0, 678.0], [167.0, 982.0], [752.0, 1276.0], [694.5, 242.0], [507.0, 682.5], [1105.0, 1064.0]], [[710.0, 801.5], [1157.0, 680.0], [164.0, 988.0], [751.0, 1278.0], [689.5, 248.0], [507.5, 686.0], [1097.0, 1068.0]], [[708.0, 807.5], [1157.0, 688.0], [163.0, 995.0], [750.0, 1286.0], [686.5, 257.0], [509.5, 693.0], [1090.0, 1077.0]], [[705.0, 810.5], [1156.0, 689.0], [159.0, 995.0], [748.0, 1288.0], [680.5, 258.0], [509.5, 694.0], [1082.0, 1080.0]], [[701.5, 806.0], [1155.0, 685.0], [154.0, 989.0], [746.0, 1283.0], [676.5, 253.5], [509.5, 689.0], [1074.0, 1077.0]], [[696.5, 802.0], [1150.0, 681.0], [148.0, 987.0], [742.0, 1279.0], [667.5, 251.5], [505.5, 686.0], [1064.0, 1075.0]], [[690.0, 801.5], [1145.0, 681.0], [141.5, 986.0], [738.0, 1278.0], [659.5, 250.0], [502.0, 685.5], [1053.5, 1076.0]], [[686.0, 801.5], [1143.0, 679.0], [136.5, 986.0], [734.0, 1277.0], [653.5, 249.0], [500.0, 684.5], [1046.5, 1075.0]], [[682.0, 803.5], [1139.0, 680.0], [133.0, 991.0], [731.0, 1280.0], [646.5, 252.0], [498.0, 687.5], [1038.5, 1077.0]], [[679.0, 806.5], [1137.0, 682.0], [128.5, 991.0], [731.0, 1282.0], [642.5, 254.5], [497.0, 689.5], [1034.5, 1080.0]], [[677.0, 802.5], [1137.0, 681.0], [127.0, 989.0], [730.0, 1279.0], [640.5, 252.5], [496.0, 687.5], [1028.5, 1078.0]], [[675.0, 798.5], [1137.0, 675.0], [125.5, 983.0], [729.0, 1274.0], [637.5, 246.5], [497.0, 682.5], [1026.5, 1073.0]], [[678.0, 794.5], [1141.0, 670.5], [130.0, 981.0], [733.0, 1270.0], [637.5, 242.5], [500.0, 679.5], [1026.5, 1070.0]], [[683.0, 791.5], [1147.0, 668.0], [136.0, 978.0], [740.0, 1267.0], [640.5, 239.5], [505.0, 675.5], [1029.5, 1066.0]], [[687.0, 789.5], [1152.0, 664.0], [142.0, 975.0], [744.0, 1265.0], [646.5, 236.0], [510.0, 674.5], [1035.5, 1064.0]], [[694.0, 790.5], [1160.0, 665.0], [147.0, 976.0], [750.5, 1267.5], [652.5, 236.5], [518.0, 675.5], [1041.5, 1065.0]], [[700.0, 794.5], [1168.0, 669.0], [153.5, 979.0], [758.5, 1271.5], [658.5, 242.5], [525.0, 679.5], [1048.5, 1071.0]], [[708.0, 794.5], [1177.0, 669.0], [162.5, 979.0], [766.0, 1272.0], [665.5, 242.5], [534.0, 679.5], [1055.5, 1072.0]], [[716.0, 795.5], [1187.0, 669.0], [170.5, 980.0], [775.0, 1272.0], [672.5, 242.0], [543.0, 680.5], [1062.5, 1073.0]], [[724.0, 800.5], [1196.0, 673.0], [181.5, 985.0], [784.0, 1278.0], [679.5, 247.5], [552.5, 684.0], [1070.5, 1078.0]], [[732.0, 807.5], [1206.0, 679.0], [189.5, 992.0], [794.0, 1285.0], [686.5, 256.0], [561.0, 690.5], [1077.5, 1085.0]], [[739.0, 809.5], [1214.0, 681.0], [196.5, 995.0], [801.5, 1289.0], [693.5, 257.5], [568.0, 695.5], [1084.5, 1088.0]], [[745.0, 811.5], [1222.0, 683.0], [202.5, 997.0], [807.5, 1292.0], [698.5, 260.5], [575.0, 696.5], [1090.5, 1091.0]], [[750.0, 814.5], [1229.0, 685.0], [208.5, 998.0], [814.5, 1294.0], [702.5, 261.5], [582.0, 698.5], [1093.5, 1092.0]], [[754.0, 811.5], [1234.0, 684.0], [211.5, 996.0], [819.0, 1293.0], [704.5, 261.0], [586.0, 696.5], [1095.5, 1092.0]], [[757.0, 805.5], [1239.0, 677.5], [214.5, 990.0], [823.0, 1287.0], [706.5, 252.0], [591.0, 690.5], [1097.5, 1087.0]], [[763.0, 800.5], [1246.0, 672.5], [221.5, 987.0], [830.0, 1283.0], [712.5, 246.5], [597.0, 686.5], [1102.5, 1083.5]], [[765.0, 800.5], [1250.0, 671.5], [223.5, 986.0], [833.0, 1283.0], [713.5, 246.0], [601.0, 686.5], [1104.5, 1083.5]], [[765.0, 800.5], [1252.0, 671.5], [223.5, 985.0], [832.0, 1283.0], [714.5, 246.0], [602.0, 685.5], [1104.5, 1084.5]], [[760.0, 799.5], [1247.5, 671.5], [216.5, 984.0], [827.0, 1283.0], [706.5, 243.0], [596.0, 684.5], [1098.5, 1083.5]], [[753.0, 793.5], [1240.5, 664.5], [207.5, 977.0], [820.0, 1276.0], [700.5, 234.0], [590.0, 676.5], [1090.5, 1076.5]], [[747.5, 788.0], [1236.5, 658.0], [201.5, 974.0], [816.0, 1271.0], [694.5, 227.0], [585.0, 672.5], [1083.5, 1072.5]], [[745.5, 786.0], [1234.5, 656.5], [198.0, 973.0], [813.0, 1268.0], [692.5, 225.0], [583.0, 669.5], [1079.5, 1070.5]], [[743.0, 783.5], [1233.5, 653.5], [196.5, 971.0], [812.0, 1267.0], [688.5, 222.0], [581.0, 668.5], [1077.5, 1068.5]], [[740.0, 787.5], [1230.5, 657.5], [193.0, 977.0], [809.0, 1272.0], [684.5, 227.0], [579.0, 673.5], [1073.5, 1071.5]], [[738.0, 790.5], [1227.5, 659.5], [190.0, 979.0], [808.0, 1275.0], [681.5, 230.0], [578.0, 675.5], [1070.5, 1074.5]], [[738.0, 788.5], [1229.5, 658.5], [193.5, 975.0], [809.0, 1272.0], [681.5, 227.0], [580.0, 673.5], [1068.5, 1070.5]], [[733.0, 785.5], [1223.5, 655.5], [185.0, 973.0], [804.0, 1269.0], [673.5, 224.0], [575.0, 671.5], [1060.5, 1067.5]], [[726.0, 783.5], [1216.0, 654.5], [178.0, 971.0], [797.0, 1268.0], [666.5, 223.0], [569.0, 670.5], [1051.5, 1064.5]], [[723.0, 784.5], [1213.0, 655.5], [174.5, 970.0], [794.0, 1268.0], [663.5, 224.0], [567.0, 671.5], [1047.5, 1064.5]], [[719.0, 782.5], [1209.0, 655.5], [171.0, 969.0], [789.0, 1267.0], [659.5, 223.0], [564.0, 671.5], [1039.5, 1062.5]], [[715.0, 780.5], [1206.0, 654.0], [167.0, 966.0], [785.0, 1265.0], [657.5, 221.0], [561.0, 669.5], [1035.5, 1060.5]], [[713.0, 782.5], [1204.0, 655.5], [164.5, 966.0], [782.0, 1267.0], [656.5, 222.0], [561.0, 670.5], [1029.5, 1059.5]], [[713.0, 786.5], [1204.0, 662.0], [163.5, 968.0], [781.0, 1271.0], [656.5, 226.0], [562.0, 673.5], [1027.5, 1064.5]], [[715.0, 787.5], [1206.0, 665.0], [165.5, 966.0], [781.0, 1274.0], [660.5, 229.0], [565.0, 675.5], [1026.5, 1065.5]], [[714.0, 785.5], [1206.0, 666.0], [165.0, 963.0], [778.0, 1273.0], [660.5, 227.0], [565.0, 674.5], [1023.5, 1065.5]], [[708.0, 782.5], [1201.0, 664.5], [155.5, 957.0], [772.0, 1269.0], [654.5, 221.5], [559.0, 669.5], [1015.5, 1062.5]], [[702.0, 779.5], [1195.5, 661.5], [149.0, 956.0], [765.0, 1267.0], [647.5, 221.0], [554.0, 668.5], [1007.5, 1059.5]], [[696.0, 777.5], [1189.0, 661.5], [140.5, 951.0], [758.0, 1265.0], [643.5, 216.0], [549.0, 664.5], [999.5, 1058.5]], [[691.0, 773.5], [1184.0, 657.5], [133.5, 946.0], [753.0, 1260.0], [637.5, 211.0], [545.0, 660.5], [991.5, 1053.5]], [[688.0, 774.5], [1183.0, 657.5], [132.5, 946.0], [750.0, 1261.0], [636.5, 211.0], [544.0, 661.5], [989.5, 1054.5]], [[692.0, 774.5], [1186.0, 659.5], [137.5, 946.0], [753.0, 1263.0], [639.5, 212.0], [548.0, 662.5], [989.5, 1056.5]], [[699.0, 775.5], [1196.0, 661.5], [145.5, 945.0], [760.0, 1264.0], [648.5, 213.0], [556.5, 661.5], [996.5, 1059.5]], [[706.0, 778.5], [1204.5, 664.5], [151.5, 946.0], [766.0, 1267.0], [656.5, 215.5], [565.5, 664.5], [1002.5, 1062.5]], [[708.0, 784.5], [1207.0, 672.5], [154.5, 950.5], [766.0, 1274.0], [660.5, 225.0], [568.5, 669.5], [1002.5, 1070.5]], [[711.0, 784.5], [1211.5, 676.5], [157.5, 949.5], [769.0, 1276.0], [665.5, 226.0], [571.5, 670.5], [1003.5, 1072.5]], [[715.0, 783.5], [1217.0, 676.5], [160.0, 944.5], [772.0, 1273.0], [670.5, 222.0], [577.0, 669.5], [1007.5, 1072.5]], [[716.0, 782.5], [1218.0, 677.5], [161.5, 942.0], [771.0, 1273.0], [672.5, 222.0], [578.0, 667.5], [1006.5, 1071.5]], [[713.0, 777.5], [1217.0, 674.5], [159.5, 934.0], [766.0, 1268.0], [673.5, 214.0], [577.0, 662.5], [1002.5, 1068.5]], [[709.0, 771.5], [1212.0, 668.5], [151.5, 925.5], [759.0, 1261.0], [670.5, 207.0], [572.0, 656.5], [994.5, 1061.5]], [[704.0, 769.5], [1209.0, 669.5], [145.5, 923.5], [753.0, 1260.0], [666.5, 206.0], [569.0, 654.5], [988.5, 1060.5]], [[701.0, 769.5], [1208.0, 671.0], [144.5, 921.5], [751.0, 1260.0], [664.5, 206.0], [568.0, 653.5], [984.5, 1060.5]], [[701.0, 766.5], [1208.0, 667.5], [140.0, 916.5], [748.0, 1257.0], [662.5, 201.0], [567.0, 650.5], [981.5, 1057.5]], [[694.0, 768.5], [1202.0, 668.5], [134.0, 918.5], [744.0, 1259.0], [655.5, 203.0], [563.0, 652.5], [973.5, 1058.5]], [[687.0, 767.5], [1196.0, 669.5], [127.5, 918.5], [738.0, 1259.0], [650.5, 203.5], [558.5, 652.0], [964.5, 1057.5]], [[687.0, 765.5], [1195.0, 668.5], [126.5, 915.0], [736.0, 1258.0], [649.5, 200.0], [558.0, 651.5], [962.5, 1055.5]], [[690.0, 764.5], [1199.0, 668.5], [130.5, 913.0], [739.0, 1258.0], [652.5, 200.0], [562.0, 650.5], [962.5, 1055.5]], [[686.0, 761.5], [1197.0, 665.0], [123.5, 910.0], [735.0, 1254.0], [646.5, 194.0], [558.0, 648.5], [956.5, 1049.5]], [[681.0, 755.5], [1192.0, 660.0], [119.5, 904.0], [732.0, 1249.0], [640.5, 187.0], [555.0, 642.5], [947.5, 1043.5]], [[674.0, 751.5], [1188.0, 655.0], [113.0, 902.0], [726.0, 1246.0], [631.5, 183.5], [551.0, 638.5], [938.5, 1039.5]], [[670.0, 754.5], [1185.0, 657.0], [106.5, 904.5], [722.0, 1249.0], [627.5, 185.5], [549.0, 642.5], [931.5, 1041.5]], [[666.0, 761.5], [1181.0, 666.0], [104.5, 911.0], [719.0, 1258.0], [624.5, 194.5], [547.0, 650.5], [927.5, 1048.5]], [[663.0, 757.5], [1181.0, 664.0], [101.5, 905.0], [716.5, 1253.5], [623.5, 187.5], [546.0, 645.5], [921.5, 1043.5]], [[662.0, 747.5], [1180.0, 656.0], [98.0, 895.0], [712.5, 1244.5], [622.5, 177.0], [544.0, 636.5], [918.5, 1034.5]], [[658.0, 750.5], [1175.0, 660.0], [90.0, 895.0], [707.5, 1247.5], [619.5, 178.0], [540.0, 640.5], [912.5, 1038.5]], [[653.0, 747.5], [1171.0, 659.0], [84.5, 889.0], [700.5, 1245.5], [616.5, 173.0], [536.0, 635.5], [906.5, 1036.5]], [[656.0, 739.5], [1175.0, 652.0], [86.0, 881.0], [700.5, 1238.5], [620.5, 164.0], [539.0, 627.5], [908.5, 1031.5]], [[658.0, 746.5], [1178.0, 661.0], [87.5, 885.0], [701.5, 1245.5], [625.5, 169.5], [541.5, 632.0], [910.5, 1039.5]], [[658.0, 755.5], [1178.0, 671.0], [85.5, 894.0], [698.5, 1255.5], [626.5, 180.5], [540.5, 641.0], [910.5, 1052.5]], [[657.0, 756.5], [1178.0, 673.0], [83.5, 894.0], [695.5, 1257.5], [627.5, 180.5], [539.5, 641.0], [910.5, 1056.5]], [[657.0, 754.5], [1178.0, 672.0], [83.5, 891.0], [695.5, 1254.5], [628.5, 178.0], [539.5, 637.0], [909.5, 1057.5]], [[657.0, 757.5], [1180.0, 676.0], [82.0, 893.0], [693.5, 1257.5], [630.5, 180.5], [539.5, 640.0], [909.5, 1061.5]], [[654.0, 760.5], [1176.0, 681.0], [76.5, 893.0], [689.5, 1261.5], [628.5, 184.0], [536.5, 642.0], [905.5, 1067.5]], [[656.0, 756.5], [1179.0, 678.0], [81.5, 890.0], [690.5, 1258.5], [630.5, 181.0], [540.5, 638.0], [905.5, 1064.5]], [[658.0, 761.5], [1182.0, 683.5], [83.5, 893.0], [692.5, 1262.5], [635.5, 187.0], [544.5, 643.0], [906.5, 1068.5]], [[662.0, 766.5], [1185.5, 689.5], [90.5, 897.0], [696.5, 1269.5], [638.5, 193.5], [549.5, 649.0], [907.5, 1073.5]], [[668.0, 762.5], [1193.0, 688.5], [96.5, 892.0], [702.5, 1265.5], [643.5, 189.5], [556.0, 647.5], [910.5, 1069.5]], [[670.0, 762.5], [1196.0, 688.0], [98.5, 890.0], [704.5, 1265.5], [645.5, 189.5], [560.0, 647.5], [909.5, 1066.5]], [[673.0, 758.5], [1200.0, 685.0], [102.5, 886.0], [707.5, 1261.5], [648.0, 185.0], [565.0, 645.5], [910.5, 1059.5]], [[679.0, 753.5], [1206.0, 683.0], [110.0, 880.0], [713.5, 1257.5], [655.5, 181.5], [572.0, 643.5], [912.5, 1054.5]], [[686.0, 749.5], [1215.0, 676.5], [117.5, 873.0], [720.5, 1252.5], [662.5, 173.5], [580.0, 637.5], [919.5, 1045.5]], [[689.0, 746.5], [1219.0, 675.0], [122.5, 870.0], [723.5, 1251.5], [664.5, 171.5], [584.0, 636.5], [920.5, 1041.5]], [[699.0, 741.5], [1230.0, 669.5], [131.5, 864.0], [733.5, 1246.5], [675.5, 164.5], [594.0, 632.5], [930.5, 1035.5]], [[706.0, 737.5], [1238.0, 666.5], [138.5, 858.0], [739.5, 1242.5], [683.5, 158.5], [601.0, 628.5], [938.5, 1030.5]], [[714.0, 739.5], [1246.5, 667.5], [148.5, 859.0], [747.5, 1244.5], [692.5, 161.0], [608.0, 631.5], [947.0, 1031.0]], [[721.0, 739.5], [1255.0, 668.5], [155.5, 858.0], [754.5, 1244.5], [699.5, 160.5], [616.0, 630.5], [955.0, 1031.0]], [[727.0, 735.5], [1263.0, 664.5], [163.5, 855.0], [761.5, 1240.5], [705.5, 155.5], [623.0, 626.5], [961.0, 1029.0]], [[732.0, 731.5], [1270.0, 660.5], [169.5, 851.0], [767.5, 1237.5], [711.5, 152.5], [628.0, 623.5], [966.0, 1026.0]], [[737.0, 732.5], [1275.0, 661.5], [174.5, 850.0], [770.5, 1238.5], [715.0, 152.0], [633.0, 623.5], [971.0, 1024.0]], [[745.0, 732.5], [1283.0, 662.0], [182.5, 850.0], [778.5, 1238.5], [723.5, 152.5], [642.0, 623.5], [978.0, 1025.0]], [[750.0, 731.5], [1290.0, 662.0], [189.5, 850.0], [784.5, 1239.5], [729.0, 154.0], [647.0, 623.5], [982.0, 1026.0]], [[752.5, 734.0], [1294.0, 664.0], [191.5, 852.0], [786.5, 1241.5], [731.0, 155.0], [650.0, 626.5], [984.0, 1030.0]], [[754.5, 736.0], [1296.0, 666.5], [193.5, 852.5], [787.5, 1242.5], [732.5, 155.5], [652.0, 626.5], [985.0, 1031.0]], [[753.5, 735.0], [1295.0, 665.0], [192.5, 851.5], [787.5, 1242.5], [733.0, 156.0], [652.0, 626.5], [984.0, 1032.0]], [[748.5, 732.0], [1290.0, 661.5], [185.5, 847.5], [782.5, 1237.5], [727.5, 149.5], [647.0, 621.5], [977.0, 1029.0]], [[741.5, 726.0], [1282.0, 655.0], [176.5, 842.5], [775.5, 1231.5], [718.5, 142.5], [639.0, 614.5], [969.0, 1023.0]], [[735.5, 724.0], [1276.0, 652.5], [170.5, 840.0], [768.5, 1229.5], [713.5, 140.5], [634.0, 612.5], [961.0, 1022.0]], [[737.5, 724.0], [1279.0, 653.0], [174.5, 840.5], [771.5, 1229.5], [715.0, 141.0], [638.0, 612.5], [962.0, 1023.0]], [[742.5, 729.0], [1285.0, 658.0], [178.5, 845.0], [775.5, 1234.5], [720.0, 146.5], [643.5, 617.0], [968.0, 1029.0]], [[742.0, 729.5], [1286.0, 660.0], [179.5, 844.5], [776.5, 1236.5], [722.0, 146.0], [644.0, 617.5], [968.0, 1030.0]], [[745.0, 730.5], [1289.0, 662.0], [181.5, 847.5], [778.5, 1237.5], [723.5, 148.5], [648.0, 620.5], [968.0, 1032.0]], [[747.0, 738.5], [1291.0, 668.0], [185.0, 852.5], [781.5, 1245.5], [726.0, 158.5], [650.0, 626.5], [970.0, 1038.0]], [[750.0, 737.0], [1294.0, 669.0], [188.0, 852.5], [783.5, 1245.5], [728.0, 157.5], [653.0, 627.5], [973.0, 1038.0]], [[750.5, 734.5], [1295.0, 665.0], [189.5, 851.5], [785.5, 1243.5], [729.0, 155.0], [653.0, 624.5], [974.0, 1034.0]], [[751.0, 735.0], [1296.0, 665.0], [188.5, 849.5], [784.5, 1242.5], [730.0, 154.0], [654.0, 624.5], [973.0, 1031.0]], [[753.0, 733.0], [1298.0, 664.5], [190.5, 848.0], [787.5, 1241.5], [730.0, 153.0], [656.0, 625.5], [974.0, 1029.0]], [[757.0, 734.0], [1301.0, 666.0], [196.5, 849.0], [791.5, 1244.5], [733.0, 154.0], [660.0, 628.5], [979.0, 1028.0]], [[761.0, 735.0], [1307.0, 668.0], [202.5, 849.0], [795.5, 1246.5], [739.5, 154.5], [664.5, 629.5], [982.0, 1026.0]], [[768.0, 731.0], [1314.0, 665.0], [209.5, 844.5], [803.5, 1241.5], [745.5, 151.5], [673.5, 626.5], [988.0, 1021.0]], [[771.0, 727.0], [1320.0, 661.0], [215.0, 839.5], [807.5, 1238.5], [748.5, 146.5], [677.5, 623.5], [989.0, 1014.0]], [[772.0, 727.0], [1321.0, 660.5], [215.5, 840.5], [807.5, 1237.5], [749.5, 146.5], [678.5, 623.5], [989.0, 1014.0]], [[767.0, 730.0], [1315.0, 663.5], [209.0, 841.5], [802.5, 1240.5], [741.5, 149.0], [673.5, 627.5], [980.0, 1016.0]], [[762.0, 727.0], [1310.0, 661.5], [205.0, 837.5], [797.5, 1237.5], [739.5, 147.5], [671.0, 623.5], [973.0, 1014.0]], [[756.0, 726.0], [1303.0, 662.5], [197.0, 835.5], [789.5, 1236.5], [732.5, 147.5], [665.5, 623.5], [964.0, 1012.0]], [[743.5, 727.5], [1289.0, 666.0], [183.5, 835.0], [775.5, 1237.5], [722.5, 149.0], [654.5, 623.5], [947.0, 1013.0]], [[742.5, 722.5], [1289.0, 663.5], [184.5, 827.0], [772.5, 1231.5], [723.5, 142.5], [654.5, 618.5], [944.0, 1007.0]], [[738.5, 722.5], [1282.0, 666.0], [178.5, 825.0], [765.5, 1232.5], [721.5, 144.0], [650.5, 619.5], [935.0, 1008.0]], [[740.5, 720.5], [1285.0, 666.0], [179.5, 819.0], [765.5, 1229.5], [724.5, 140.5], [654.5, 616.5], [935.0, 1005.0]], [[743.5, 718.5], [1289.0, 664.5], [181.5, 818.5], [767.5, 1228.5], [728.0, 139.0], [658.5, 615.5], [935.0, 1003.0]], [[748.5, 717.5], [1295.0, 665.0], [188.5, 817.5], [773.5, 1228.5], [734.0, 139.0], [665.5, 616.5], [939.0, 1003.0]], [[756.5, 711.5], [1307.0, 659.0], [197.0, 809.5], [782.0, 1224.0], [741.5, 129.5], [674.5, 610.5], [947.0, 999.0]], [[755.5, 712.5], [1306.0, 660.5], [194.5, 812.5], [779.5, 1224.5], [738.5, 130.5], [674.5, 611.5], [941.0, 998.0]], [[758.5, 715.5], [1310.0, 663.0], [199.5, 814.5], [783.5, 1229.5], [741.5, 133.0], [678.5, 615.5], [943.0, 1001.0]], [[766.5, 717.5], [1319.0, 665.5], [207.0, 814.5], [791.5, 1231.5], [750.5, 135.0], [687.5, 617.5], [951.0, 1002.0]], [[768.5, 717.5], [1321.0, 667.5], [209.0, 814.5], [792.5, 1232.5], [751.5, 137.0], [689.5, 617.5], [950.0, 1003.0]], [[769.5, 720.5], [1323.0, 668.5], [210.5, 814.5], [793.5, 1233.5], [754.5, 138.5], [691.5, 618.5], [950.0, 1003.0]], [[773.5, 718.5], [1328.0, 669.5], [216.0, 813.5], [797.5, 1233.5], [759.5, 138.5], [696.5, 619.5], [953.0, 1003.0]], [[776.5, 718.5], [1333.0, 669.5], [219.0, 813.5], [800.5, 1233.5], [761.5, 138.5], [700.5, 619.5], [957.0, 1003.0]], [[778.0, 721.0], [1334.5, 670.5], [219.0, 815.5], [800.5, 1235.5], [762.5, 139.5], [700.5, 620.5], [957.0, 1005.0]], [[782.0, 724.0], [1338.5, 673.5], [224.0, 818.5], [804.5, 1239.5], [765.5, 143.0], [704.5, 622.5], [962.0, 1011.0]], [[787.0, 725.0], [1343.5, 674.5], [229.0, 819.5], [809.5, 1240.5], [772.5, 144.5], [709.5, 622.5], [967.0, 1013.0]], [[788.0, 725.0], [1344.5, 675.5], [229.0, 819.5], [809.5, 1240.5], [773.5, 145.0], [709.5, 623.5], [969.0, 1016.0]], [[789.0, 726.0], [1346.0, 677.5], [231.0, 820.5], [811.5, 1241.5], [776.5, 146.0], [710.0, 623.0], [973.0, 1019.0]], [[795.0, 727.0], [1353.5, 677.5], [236.0, 821.5], [816.5, 1241.5], [783.5, 146.5], [715.5, 622.5], [980.0, 1022.0]], [[797.0, 728.0], [1355.0, 678.5], [238.0, 821.5], [817.5, 1242.5], [786.0, 147.0], [715.5, 621.5], [984.0, 1025.0]]]
    centers_each_frame = np.array(centers_each_frame[0:40])

    point_image_matrix = np.ones(centers_each_frame.shape[0:2])
    start = np.random.rand(point_image_matrix.shape[1]*3 + point_image_matrix.shape[0]*6)*0.001

    # start = np.array([0.68033395,0.89513883,0.11439259,0.07928412,0.30796123,0.6187931
    #                 ,0.41464469,0.43424462,0.3129148,0.86120692,0.58502742,0.06013444
    #                 ,0.54791315,0.4416593,0.60796811,0.78920153,0.51892708,0.04847837
    #                 ,0.97226763,0.77240886,0.53058958,0.28159572,0.78628401,0.30221677
    #                 ,0.42279255,0.53513369,0.58582055,0.87483053,0.23450286,0.41116056
    #                 ,0.62872717,0.00922681,0.89639328,0.28470694,0.9743538,0.33385515
    #                 ,0.0455611,0.87205774,0.94911263,0.9340711,0.7188728,0.35666293
    #                 ,0.77851388,0.39316883,0.62683743,0.66549939,0.06468418,0.70906265
    #                 ,0.2585899,0.14328983,0.14055355,0.43966732,0.08086328,0.33981993
    #                 ,0.90236589,0.96243477,0.18010735,0.23968057,0.34744975,0.69333598
    #                 ,0.70828383,0.83210636,0.87760776,0.98754511,0.29343235,0.53302398
    #                 ,0.69805405,0.52881379,0.43884261,0.97031395,0.0371593,0.26961959
    #                 ,0.06438502,0.14720275,0.40290856,0.5529229,0.55395824,0.13569169
    #                 ,0.16865675,0.43134863,0.39528449,0.73543681,0.58841297,0.84621847
    #                 ,0.17184199,0.70497385,0.27228941,0.14721434,0.19292355,0.35502724
    #                 ,0.23748579,0.64564984,0.88071220,0.04307208,0.15241331,0.3144742
    #                 ,0.6346944,0.49947922,0.84771615,0.94981088,0.80271327,0.10061722
    #                 ,0.52602566,0.91235774,0.89866384,0.44016221,0.69769934,0.01912397
    #                 ,0.62451693,0.32630671,0.65555406,0.39657405,0.66322092,0.98902467
    #                 ,0.32143499,0.32173258,0.88787463,0.69043598,0.09021904,0.49100644
    #                 ,0.8234374,0.06297496,0.70963247,0.23114475,0.7570602,0.55836397
    #                 ,0.40115161,0.32467913,0.16371])
    print(start)


    K = np.array([[-13.50441236, 0.2388132, 0.15245594],
                  [ -0.        , -13.4455227, 0.65115269],
                  [  0.        , 0.       , 1.        ]])

    cameras, points = bundle_adjustment.numerical_levenberg_marquardt_bundle_adjustment(start, np.swapaxes(centers_each_frame, 0, 1), point_image_matrix.T, K)

    DIST = .33
    real_points_m = np.array([
        [0,0,0], # White
        [DIST,0,0], # Purple
        [-DIST,0,0], # Silver
        [0,DIST,0], # Orange
        [0,-DIST,0], # Red
        [0,0,DIST], # Blue
        [0,0,-DIST], # Yellow
    ])

    colors = [
        [255,255,255], # White
        [250, 150, 150], # Purple
        [220, 220, 220], # Silver
        [0, 165, 255],  # Orange
        [0, 0, 255], # Red
        [255, 0, 0], # Blue
        [0, 255, 255], # Yellow
    ]

    print(points[0])

    for c in cameras:
        internal, rotation, position = li_utils.get_projection_product_matricies(c)
        print(position)
        plt = draw_utils.show_scene(points, internal, rotation, position, colors=np.array(colors)/255)

def try7():
    K = np.array([[-13.50441236, 0.2388132, 0.15245594],
                  [ -0.        , -13.4455227, 0.65115269],
                  [  0.        , 0.       , 1.        ]])
    K_inv = np.linalg.inv(K)

    # vs = cv2.VideoCapture('photos/star_v.mp4')
    # _, frame1 = vs.read()
    # uncalibrated_1 = image_utils.show_image_select_points("", frame1, colors=colors)
    # print(uncalibrated_1)
    # _, frame2 = utils.get_last_frame(vs)
    # uncalibrated_2 = image_utils.show_image_select_points("", frame2, colors=colors)
    # print(uncalibrated_2)

    uncalibrated_1 = np.array([(712, 712), (681, 729), (775, 686), (974, 708), (456, 739), (712, 460), (734, 979), (969, 835), (991, 300), (969, 338)])
    uncalibrated_2 = np.array([(748, 816), (691, 1360), (830, 237), (1260, 837), (153, 782), (614, 717), (1022, 984), (1416, 1063), (945, 520), (936, 645)])

    c1_pts, avg_c1, scale_c1 = li_utils.normalize_points(uncalibrated_1)
    c2_pts, avg_c2, scale_c2 = li_utils.normalize_points(uncalibrated_2)

    c1_pts, c2_pts = li_utils.point_lists_to_homogeneous_coordinates(c1_pts, c2_pts)

    print(c1_pts.shape)

    scaled_calibrated_pts_1 = K_inv @ c1_pts
    scaled_calibrated_pts_2 = K_inv @ c2_pts


    P1, P2 = two_view_calibration.get_uncalibrated_camera_location_relative_to_first(scaled_calibrated_pts_1, scaled_calibrated_pts_2)
    
    # c1_norm_matrix  = li_utils.construct_normalization_matrix(4, avg_c1, scale_c1)
    # c1_norm_matrix_inv = np.linalg.inv(c1_norm_matrix)

    # P1_unnormalized = P1@c1_norm_matrix_inv
    # P1_unnormalized /= P1_unnormalized[-1,-1]

    # c2_norm_matrix = li_utils.construct_normalization_matrix(3, avg_c2, scale_c2)
    # c2_norm_matrix_inv = np.linalg.inv(c2_norm_matrix)

    # P2_unnormalized = P2@c2_norm_matrix_inv
    # P2_unnormalized /= P2_unnormalized[-1,-1]

    X_est = li_utils.triangulate_points(P1, P2, scaled_calibrated_pts_1, scaled_calibrated_pts_2)

    DIST = .33
    real_points_m = np.array([
        [0,0,0], # White
        [DIST,0,0], # Purple
        [-DIST,0,0], # Silver
        [0,DIST,0], # Orange
        [0,-DIST,0], # Red
        [0,0,DIST], # Blue
        [0,0,-DIST], # Yellow
    ])

    R1_est, p1_est = li_utils.get_rotation_and_position_from_calibrated_projection_matrix(P1)
    R2_est, p2_est = li_utils.get_rotation_and_position_from_calibrated_projection_matrix(P2)

    scale, R_sc, T = li_utils.iterative_closest_point_with_scale(real_points_m.T,X_est[0:7])

    X_sc = scale*R_sc@X_est + T

    print(abs(X_sc[:,0:7]-real_points_m.T))

    R1_sc = R_sc@R1_est
    R2_sc = R2_est@R_sc.T
    p1_sc = scale*R_sc@p1_est + T
    p2_sc = scale*R_sc@p2_est + T

    rotations = [
        R1_sc,
        R2_sc
    ]

    positions = [
        p1_sc,
        p2_sc
    ]

    colors_flipped = [
        [255,255,255], # White
        [150, 150, 250], # Purple
        [220, 220, 220], # Silver
        [255, 165, 0],  # Orange
        [255, 0, 0], # Red
        [0, 0, 255], # Blue
        [255, 255, 0], # Yellow
    ]

    draw_utils.show_multi_cam_scene(X_sc.T[0:7], positions, rotations, colors=np.array(colors_flipped)/255)

if __name__ == '__main__':
    try7()



